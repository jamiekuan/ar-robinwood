<script>
  AFRAME.registerComponent("auto-switch-model", {
    init: function () {
      const model1 = document.querySelector("#model1-entity");
      const model2 = document.querySelector("#model2-entity");
      const text = document.querySelector("#dialogue-text");

      const dialogue = [
        "Congratulation!",
        "You've found all exhibitions today,",
        "but...",
        "I won't stop stealing staffs,",
        "as I'm Robinwood!",
      ];
      let currentLine = 0;
      let model2Plays = 0;
      let inModel2 = false;

      const advanceDialogue = () => {
        if (currentLine < dialogue.length - 1) {
          currentLine++;
        } else {
          currentLine = 0;
        }
        text.setAttribute("value", dialogue[currentLine]);
      };

      // 點擊任一模型或文字 → 下一句
      model1.addEventListener("click", advanceDialogue);
      model2.addEventListener("click", advanceDialogue);
      text.addEventListener("click", advanceDialogue);

      const switchToModel1 = () => {
        model2.setAttribute("visible", false);
        model1.setAttribute("visible", true);
        model1.components["animation-mixer"].mixer.stopAllAction(); // reset
        model1.setAttribute("animation-mixer", { clip: "*", loop: "once" });
        inModel2 = false;
      };

      const switchToModel2 = () => {
        model1.setAttribute("visible", false);
        model2.setAttribute("visible", true);
        model2.components["animation-mixer"].mixer.stopAllAction(); // reset
        model2.setAttribute("animation-mixer", { clip: "*", loop: "once" });
        inModel2 = true;
      };

      // 初始化：強制 5 秒後進入 model2
      setTimeout(() => {
        switchToModel2();
      }, 5000);

      // 監聽 animation 結束
      model1.addEventListener("animation-finished", () => {
        if (!inModel2) {
          switchToModel2();
        }
      });

      model2.addEventListener("animation-finished", () => {
        model2Plays++;
        if (model2Plays >= 3) {
          model2Plays = 0;
          switchToModel1();
        } else {
          // 重新播放 model2
          model2.components["animation-mixer"].mixer.stopAllAction(); // reset
          model2.setAttribute("animation-mixer", { clip: "*", loop: "once" });
        }
      });
    },
  });

  document.querySelector("a-scene").setAttribute("auto-switch-model", "");
</script>
